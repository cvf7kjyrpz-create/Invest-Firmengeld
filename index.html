<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portfolio V7</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Portfolio">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #ffffff;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        input, select {
            background: #1c1c1e;
            border: 1px solid #2c2c2e;
            color: white;
            transition: all 0.2s ease;
            appearance: none;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #4ade80;
            background: #252527;
        }
        input::placeholder { color: #52525b; }
        input[type="date"] { color-scheme: dark; }

        .bg-card { background: #1c1c1e; }
        
        /* Animations */
        .spin-slow { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .entry-item { transition: all 0.2s ease; }
        .entry-item.deleting { transform: translateX(-100%); opacity: 0; }
        
        /* Glassy Gradients */
        .gradient-gold { background: linear-gradient(135deg, rgba(234, 179, 8, 0.15), rgba(0,0,0,0)); border: 1px solid rgba(234, 179, 8, 0.2); }
        .gradient-blue { background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(0,0,0,0)); border: 1px solid rgba(59, 130, 246, 0.2); }
    </style>
</head>
<body class="h-screen flex flex-col px-4 pt-10 pb-8 bg-black">

    <div class="bg-gray-900 rounded-3xl p-6 mb-5 border border-gray-800 relative overflow-hidden shadow-2xl shrink-0">
        <div id="glow-bg" class="absolute -top-10 -right-10 w-48 h-48 bg-blue-600 rounded-full blur-[80px] opacity-20 pointer-events-none transition-colors duration-700"></div>

        <div class="flex justify-between items-start mb-1 relative z-10">
            <div>
                <p class="text-gray-500 text-[10px] font-bold uppercase tracking-widest mb-2">Gesamtvermögen</p>
                <h1 id="currentValueDisplay" class="text-5xl font-extrabold tracking-tight text-white mb-1">0,00 €</h1>
            </div>
            
            <button onclick="fetchLivePrices()" id="btnRefresh" class="bg-gray-800/80 backdrop-blur p-2.5 rounded-full text-blue-400 border border-gray-700 active:scale-90 transition-all">
                <i id="iconRefresh" class="ph-bold ph-cloud-arrow-down text-xl"></i>
            </button>
        </div>
        
        <div class="flex items-center gap-3 relative z-10">
            <div id="plContainer" class="bg-gray-800/50 backdrop-blur px-3 py-1.5 rounded-lg border border-gray-700 flex items-center gap-2">
                <span id="plDisplay" class="text-sm font-bold text-gray-300">0,00 €</span>
                <span id="plPercent" class="text-xs font-bold text-gray-500 bg-black/30 px-1.5 py-0.5 rounded">0.00%</span>
            </div>
            <span class="text-[10px] text-gray-600 font-medium uppercase tracking-wider">Seit Beginn</span>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-5 shrink-0">
        <div class="rounded-2xl p-4 gradient-gold relative">
            <div class="flex justify-between items-start mb-2">
                <div class="bg-yellow-500/10 p-1.5 rounded-lg text-yellow-500"><i class="ph-fill ph-coins"></i></div>
                <span id="metalPLDisplay" class="text-[10px] font-bold text-gray-400">0%</span>
            </div>
            <p class="text-[10px] font-bold uppercase text-gray-500 mb-0.5">Edelmetalle</p>
            <h2 id="metalValueDisplay" class="text-xl font-bold text-white">0 €</h2>
        </div>

        <div class="rounded-2xl p-4 gradient-blue relative">
            <div class="flex justify-between items-start mb-2">
                <div class="bg-blue-500/10 p-1.5 rounded-lg text-blue-500"><i class="ph-fill ph-chart-line-up"></i></div>
                <span id="etfPLDisplay" class="text-[10px] font-bold text-gray-400">0%</span>
            </div>
            <p class="text-[10px] font-bold uppercase text-gray-500 mb-0.5">Aktien / ETF</p>
            <h2 id="etfValueDisplay" class="text-xl font-bold text-white">0 €</h2>
        </div>
    </div>

    <div class="mb-4 shrink-0">
        <button onclick="document.getElementById('addForm').classList.toggle('hidden')" class="w-full py-3 bg-[#1c1c1e] border border-gray-800 rounded-xl text-xs font-bold uppercase tracking-wider text-gray-400 flex items-center justify-center gap-2 active:bg-gray-800 transition-colors">
            <i class="ph-bold ph-plus"></i> Neuen Kauf eintragen
        </button>
    </div>

    <div id="addForm" class="hidden bg-card p-4 rounded-xl mb-6 border border-gray-800 animate-fade-in-down shrink-0">
        <div class="flex flex-col gap-3">
            <div class="flex gap-3">
                <div class="w-1/3">
                    <label class="text-[10px] text-gray-500 font-bold ml-1 uppercase">Typ</label>
                    <select id="inputCategory" onchange="updateLabels()" class="w-full h-10 rounded-lg px-2 text-xs mt-1 font-bold text-center">
                        <option value="gold">Gold</option>
                        <option value="silver">Silber</option>
                        <option value="etf">S&P 500</option>
                    </select>
                </div>
                <div class="w-2/3">
                    <label class="text-[10px] text-gray-500 font-bold ml-1 uppercase">Was?</label>
                    <input type="text" id="inputProduct" placeholder="z.B. 1oz Krügerrand" class="w-full h-10 rounded-lg px-3 text-sm mt-1">
                </div>
            </div>

            <div class="flex gap-3">
                <div class="w-1/2">
                    <label class="text-[10px] text-gray-500 font-bold ml-1 uppercase text-yellow-500">Bezahlt (€)</label>
                    <input type="number" id="inputAmount" placeholder="Echter Preis" step="0.01" inputmode="decimal" class="w-full h-10 rounded-lg px-3 text-base font-bold mt-1 border-gray-700 focus:border-yellow-500">
                </div>
                <div class="w-1/2">
                    <label id="labelWeight" class="text-[10px] text-gray-500 font-bold ml-1 uppercase">Gewicht (g)</label>
                    <input type="number" id="inputWeight" placeholder="0.00" step="0.01" inputmode="decimal" class="w-full h-10 rounded-lg px-3 text-base font-medium mt-1">
                </div>
            </div>

            <div class="flex gap-3">
                <div class="w-1/2">
                    <label class="text-[10px] text-gray-500 font-bold ml-1 uppercase">Datum</label>
                    <input type="date" id="inputDate" class="w-full h-10 rounded-lg px-2 text-xs mt-1 text-center font-medium">
                </div>
                 <div class="w-1/2 flex items-end">
                    <button onclick="addEntry()" class="w-full h-10 bg-white text-black font-bold rounded-lg active:scale-95 transition-transform text-xs">
                        Speichern
                    </button>
                </div>
            </div>
            <p class="text-[9px] text-gray-600 text-center mt-1">"Bezahlt" ist wichtig, um deinen echten Gewinn inkl. Händler-Aufschlag zu berechnen.</p>
        </div>
    </div>

    <div class="flex-1 overflow-hidden flex flex-col mb-4">
        <div id="historyList" class="overflow-y-auto no-scrollbar pb-4 space-y-2">
            </div>
    </div>

    <div class="mt-auto pt-4 border-t border-gray-900 shrink-0 pb-safe">
        <div class="flex justify-between items-center px-2">
            <span class="text-[10px] text-gray-600 font-bold uppercase tracking-widest">Datenverwaltung</span>
            <div class="flex gap-3">
                <button onclick="exportBackup()" class="flex items-center gap-1.5 text-xs font-bold text-gray-400 hover:text-white transition-colors">
                    <i class="ph-bold ph-download-simple"></i> Sichern
                </button>
                
                <input type="file" id="importFile" accept=".json" style="display:none" onchange="importBackup(this)">
                <button onclick="document.getElementById('importFile').click()" class="flex items-center gap-1.5 text-xs font-bold text-gray-400 hover:text-white transition-colors">
                    <i class="ph-bold ph-upload-simple"></i> Laden
                </button>
            </div>
        </div>
    </div>

    <input type="hidden" id="priceGold"><input type="hidden" id="priceSilver"><input type="hidden" id="priceEtf">

    <script>
        // Data Init (Using V7 keys now)
        let entries = JSON.parse(localStorage.getItem('portfolio_entries_v7')) || [];
        // Migration check from V6 if V7 is empty
        if (entries.length === 0) {
            const v6 = JSON.parse(localStorage.getItem('portfolio_entries_v6'));
            if(v6) { entries = v6; localStorage.setItem('portfolio_entries_v7', JSON.stringify(entries)); }
        }

        let marketPrices = JSON.parse(localStorage.getItem('portfolio_prices_v7')) || { gold: 0, silver: 0, etf: 0, lastUpdate: 'Nie' };

        // DOM Linking
        const elCurrentValue = document.getElementById('currentValueDisplay');
        const elPL = document.getElementById('plDisplay');
        const elPLPercent = document.getElementById('plPercent');
        const elPLContainer = document.getElementById('plContainer');
        const elHistory = document.getElementById('historyList');
        
        const elMetalValue = document.getElementById('metalValueDisplay');
        const elMetalPL = document.getElementById('metalPLDisplay');
        const elEtfValue = document.getElementById('etfValueDisplay');
        const elEtfPL = document.getElementById('etfPLDisplay');

        const inpPriceGold = document.getElementById('priceGold');
        const inpPriceSilver = document.getElementById('priceSilver');
        const inpPriceEtf = document.getElementById('priceEtf');

        // Restore Prices
        inpPriceGold.value = marketPrices.gold || 0;
        inpPriceSilver.value = marketPrices.silver || 0;
        inpPriceEtf.value = marketPrices.etf || 0;

        // Auto Start
        document.addEventListener("DOMContentLoaded", () => { render(); fetchLivePrices(); });
        document.addEventListener("visibilitychange", () => { if (document.visibilityState === 'visible') fetchLivePrices(); });

        // --- BACKUP & RESTORE FUNCTIONS ---

        function exportBackup() {
            const data = {
                entries: entries,
                prices: marketPrices,
                version: 'v7',
                exportDate: new Date().toISOString()
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
            const downloadAnchorNode = document.createElement('a');
            const dateStr = new Date().toISOString().split('T')[0];
            
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "portfolio_backup_" + dateStr + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importBackup(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if(confirm("Warnung: Deine aktuellen Daten werden mit dem Backup überschrieben. Fortfahren?")) {
                        if(data.entries) {
                            entries = data.entries;
                            localStorage.setItem('portfolio_entries_v7', JSON.stringify(entries));
                        }
                        if(data.prices) {
                            marketPrices = data.prices;
                            localStorage.setItem('portfolio_prices_v7', JSON.stringify(marketPrices));
                        }
                        alert("Backup erfolgreich geladen!");
                        location.reload(); // Reload to refresh everything cleanly
                    }
                } catch (err) {
                    alert("Fehler: Ungültige Backup-Datei.");
                    console.error(err);
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset input
        }

        // --- CORE FUNCTIONS ---

        async function fetchLivePrices() {
            const icon = document.getElementById('iconRefresh');
            icon.classList.remove('ph-cloud-arrow-down', 'text-red-500');
            icon.classList.add('ph-spinner', 'spin-slow', 'text-blue-400');
            
            try {
                const fetchSymbol = async (symbol) => {
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`;
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    const data = await response.json();
                    if(!data.contents) throw new Error("No Data");
                    return JSON.parse(data.contents).chart.result[0].meta.regularMarketPrice;
                };

                const [goldOz, silverOz, etfPrice] = await Promise.all([
                    fetchSymbol('XAUEUR=X'),
                    fetchSymbol('XAGEUR=X'),
                    fetchSymbol('SXR8.DE')
                ]);

                marketPrices.gold = goldOz / 31.1034768; 
                marketPrices.silver = silverOz / 31.1034768;
                marketPrices.etf = etfPrice;
                
                const now = new Date();
                marketPrices.lastUpdate = now.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});
                
                localStorage.setItem('portfolio_prices_v7', JSON.stringify(marketPrices));
                
                inpPriceGold.value = marketPrices.gold;
                inpPriceSilver.value = marketPrices.silver;
                inpPriceEtf.value = marketPrices.etf;
                render();

                icon.classList.remove('ph-spinner', 'spin-slow');
                icon.classList.add('ph-check', 'text-green-500');
                setTimeout(() => {
                    icon.classList.remove('ph-check', 'text-green-500');
                    icon.classList.add('ph-cloud-arrow-down', 'text-blue-400');
                }, 2000);

            } catch (e) {
                console.error(e);
                icon.classList.remove('ph-spinner', 'spin-slow', 'text-blue-400');
                icon.classList.add('ph-warning', 'text-red-500');
            }
        }

        function addEntry() {
            const amt = parseFloat(document.getElementById('inputAmount').value);
            const wgt = parseFloat(document.getElementById('inputWeight').value);
            const cat = document.getElementById('inputCategory').value;
            const prod = document.getElementById('inputProduct').value.trim();
            const date = document.getElementById('inputDate').value;

            if (!amt || amt <= 0) { alert("Bitte 'Bezahlt' eingeben."); return; }

            let label = prod;
            if(!label) label = (cat === 'etf') ? "S&P 500" : (cat === 'gold' ? "Gold" : "Silber");

            entries.unshift({
                id: Date.now(),
                amount: amt,
                weight: wgt || 0,
                category: cat,
                product: label,
                date: date || new Date().toISOString().split('T')[0]
            });

            entries.sort((a, b) => new Date(b.date) - new Date(a.date));

            document.getElementById('inputAmount').value = '';
            document.getElementById('inputWeight').value = '';
            document.getElementById('inputProduct').value = '';
            document.getElementById('addForm').classList.add('hidden');
            saveAndRender();
        }

        function deleteEntry(id) {
            if(confirm('Löschen?')) {
                entries = entries.filter(e => e.id !== id);
                saveAndRender();
            }
        }

        function saveAndRender() {
            localStorage.setItem('portfolio_entries_v7', JSON.stringify(entries));
            render();
        }

        function updateLabels() {
            const cat = document.getElementById('inputCategory').value;
            const lbl = document.getElementById('labelWeight');
            const inp = document.getElementById('inputWeight');
            if(cat === 'etf') { lbl.innerText = 'Anteile (Stk)'; inp.placeholder = "2.5"; }
            else { lbl.innerText = 'Gewicht (g)'; inp.placeholder = "31.1"; }
        }

        function render() {
            let totalInv = 0, totalVal = 0;
            let mInv = 0, mVal = 0, eInv = 0, eVal = 0;

            const pGold = parseFloat(inpPriceGold.value) || 0;
            const pSilver = parseFloat(inpPriceSilver.value) || 0;
            const pEtf = parseFloat(inpPriceEtf.value) || 0;

            elHistory.innerHTML = '';

            if(entries.length === 0) {
                elHistory.innerHTML = '<div class="text-center text-gray-700 mt-10 text-xs uppercase tracking-widest">Keine Positionen</div>';
            }

            entries.forEach(e => {
                totalInv += e.amount;
                let val = 0;
                
                if(e.category === 'gold') val = e.weight * pGold;
                else if(e.category === 'silver') val = e.weight * pSilver;
                else if(e.category === 'etf') val = e.weight * pEtf;
                
                if(val === 0 && pGold === 0) val = e.amount;

                totalVal += val;

                if(e.category === 'etf') { eInv += e.amount; eVal += val; }
                else { mInv += e.amount; mVal += val; }

                const diffTime = Math.abs(new Date() - new Date(e.date));
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                let timeLabel = `Vor ${diffDays} Tagen`;
                if(diffDays === 1) timeLabel = "Heute";

                const pl = val - e.amount;
                const plP = (e.amount > 0) ? (pl / e.amount) * 100 : 0;
                const col = pl >= 0 ? 'text-green-500' : 'text-red-500';
                
                let icon = 'ph-coins'; let bg = 'bg-yellow-500/10 text-yellow-500';
                if(e.category === 'silver') { icon = 'ph-coin'; bg = 'bg-gray-500/10 text-gray-400'; }
                if(e.category === 'etf') { icon = 'ph-chart-line-up'; bg = 'bg-blue-500/10 text-blue-500'; }

                const div = document.createElement('div');
                div.className = 'bg-[#1c1c1e] p-3 rounded-2xl border border-[#2c2c2e] flex items-center gap-3 relative overflow-hidden';
                div.innerHTML = `
                    <div class="w-10 h-10 rounded-full ${bg} flex items-center justify-center text-xl shrink-0">
                        <i class="ph-fill ${icon}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline mb-0.5">
                            <h4 class="text-white font-bold text-sm truncate pr-2">${e.product}</h4>
                            <span class="text-white font-bold text-sm">${new Intl.NumberFormat('de-DE', {style:'currency', currency:'EUR'}).format(val)}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2 text-[10px] text-gray-500 font-medium">
                                <span class="bg-black/40 px-1.5 py-0.5 rounded text-gray-400">${timeLabel}</span>
                                <span>Kauf: ${new Intl.NumberFormat('de-DE', {style:'currency', currency:'EUR', maximumFractionDigits:0}).format(e.amount)}</span>
                            </div>
                            <span class="text-[10px] font-bold ${col}">${pl >= 0 ? '+' : ''}${plP.toFixed(1)}%</span>
                        </div>
                    </div>
                    <button onclick="deleteEntry(${e.id})" class="absolute right-0 top-0 bottom-0 w-12 opacity-0 hover:opacity-100 bg-gradient-to-l from-black via-black to-transparent flex items-center justify-end pr-3 text-red-500 transition-opacity">
                        <i class="ph-bold ph-trash text-lg"></i>
                    </button>
                `;
                elHistory.appendChild(div);
            });

            elCurrentValue.innerText = new Intl.NumberFormat('de-DE', {style:'currency', currency:'EUR'}).format(totalVal);
            
            const totalPL = totalVal - totalInv;
            const totalPLP = totalInv > 0 ? (totalPL / totalInv) * 100 : 0;
            
            elPL.innerText = (totalPL >= 0 ? "+" : "") + new Intl.NumberFormat('de-DE', {style:'currency', currency:'EUR'}).format(totalPL);
            elPLPercent.innerText = (totalPL >= 0 ? "+" : "") + totalPLP.toFixed(2) + "%";
            
            const glow = document.getElementById('glow-bg');
            if(totalPL >= 0) {
                elPLContainer.className = "bg-green-500/10 px-3 py-1.5 rounded-lg border border-green-500/30 flex items-center gap-2";
                elPL.className = "text-sm font-bold text-green-400";
                elPLPercent.className = "text-xs font-bold text-green-300 bg-green-500/20 px-1.5 py-0.5 rounded";
                glow.className = "absolute -top-10 -right-10 w-48 h-48 bg-green-500 rounded-full blur-[80px] opacity-20 pointer-events-none transition-colors duration-700";
            } else {
                elPLContainer.className = "bg-red-500/10 px-3 py-1.5 rounded-lg border border-red-500/30 flex items-center gap-2";
                elPL.className = "text-sm font-bold text-red-400";
                elPLPercent.className = "text-xs font-bold text-red-300 bg-red-500/20 px-1.5 py-0.5 rounded";
                glow.className = "absolute -top-10 -right-10 w-48 h-48 bg-red-500 rounded-full blur-[80px] opacity-20 pointer-events-none transition-colors duration-700";
            }

            const mPL = mVal - mInv;
            const mPLP = mInv > 0 ? (mPL / mInv) * 100 : 0;
            elMetalValue.innerText = new Intl.NumberFormat('de-DE', {style:'currency', currency:'EUR', maximumFractionDigits:0}).format(mVal);
            elMetalPL.innerText = (mPL >= 0 ? "+" : "") + mPLP.toFixed(1) + "%";
            elMetalPL.className = mPL >= 0 ? "text-[10px] font-bold text-green-500" : "text-[10px] font-bold text-red-500";

            const ePL = eVal - eInv;
            const ePLP = eInv > 0 ? (ePL / eInv) * 100 : 0;
            elEtfValue.innerText = new Intl.NumberFormat('de-DE', {style:'currency', currency:'EUR', maximumFractionDigits:0}).format(eVal);
            elEtfPL.innerText = (ePL >= 0 ? "+" : "") + ePLP.toFixed(1) + "%";
            elEtfPL.className = ePL >= 0 ? "text-[10px] font-bold text-green-500" : "text-[10px] font-bold text-red-500";
        }
    </script>
</body>
</html>
