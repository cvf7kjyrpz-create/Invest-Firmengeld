<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portfolio V18</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Portfolio">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #ffffff;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        input, select {
            background: #111;
            border: 1px solid #333;
            color: white;
            border-radius: 8px;
            appearance: none;
        }
        input:focus, select:focus { outline: none; border-color: #fff; }

        .spin-slow { animation: spin 0.8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .card-glass {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            transition: transform 0.1s ease, background 0.2s ease;
        }
        .card-glass:active { transform: scale(0.97); background: rgba(40, 40, 40, 0.6); }
        
        .grad-gold { border-top: 2px solid #EAB308; background: linear-gradient(180deg, rgba(234,179,8,0.1), rgba(0,0,0,0)); }
        .grad-silver { border-top: 2px solid #9CA3AF; background: linear-gradient(180deg, rgba(156,163,175,0.1), rgba(0,0,0,0)); }
        .grad-etf { border-top: 2px solid #3B82F6; background: linear-gradient(180deg, rgba(59,130,246,0.1), rgba(0,0,0,0)); }

        .view-section { display: none; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; }
        .modal-overlay { background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="text-white">

    <div id="viewDashboard" class="view-section active px-4 pt-8 pb-4 relative">
        
        <div class="flex justify-between items-center mb-2 shrink-0 z-20">
            <button onclick="togglePrivacy()" class="p-2 text-gray-400 hover:text-white"><i id="iconPrivacy" class="ph-bold ph-eye text-xl"></i></button>
            <div onclick="openSettings()" class="bg-[#111] px-3 py-1 rounded-full border border-[#333] flex items-center gap-2 cursor-pointer">
                <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse" id="statusDot"></div>
                <span id="priceTicker" class="text-[9px] font-mono text-gray-300">Kurse laden...</span>
            </div>
            <button onclick="forceRefresh()" class="p-2 text-blue-400 hover:text-white"><i id="iconRefresh" class="ph-bold ph-arrows-clockwise text-xl"></i></button>
        </div>

        <div class="flex flex-col items-center justify-center shrink-0 mb-4 relative z-10 min-h-[160px]">
            <p class="text-[9px] font-bold text-gray-500 uppercase tracking-widest mb-1">Gesamtvermögen</p>
            <h1 id="currentValueDisplay" class="text-5xl font-extrabold text-white mb-3 tracking-tighter">•••• €</h1>
            
            <div class="inline-flex items-center bg-[#1c1c1e] rounded-full px-4 py-1.5 border border-[#333] shadow-lg">
                <span id="plDisplay" class="text-xs font-bold text-gray-300 mr-2 border-r border-gray-600 pr-2">•••• €</span>
                <span id="plPercent" class="text-xs font-bold text-gray-500">0%</span>
            </div>
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-48 h-48 bg-blue-600/20 rounded-full blur-[80px] -z-10 pointer-events-none"></div>
        </div>

        <div class="grid grid-cols-1 gap-2 shrink-0 z-10">
            <div class="grid grid-cols-2 gap-2">
                <button onclick="switchView('history', 'gold')" class="card-glass grad-gold p-3 h-32 flex flex-col justify-between relative overflow-hidden text-left">
                    <div class="flex justify-between items-start z-10">
                        <span class="text-[9px] uppercase font-black text-yellow-500 tracking-wider">Gold</span>
                        <span id="goldPL" class="text-[9px] font-bold text-gray-500">0%</span>
                    </div>
                    <div class="z-10">
                        <div id="goldVal" class="text-xl font-bold">•••• €</div>
                        <div class="text-[8px] text-gray-500 mt-1 uppercase tracking-tighter">Tippen für Details</div>
                    </div>
                    <i class="ph-fill ph-coins absolute -bottom-2 -right-2 text-6xl text-yellow-500/10 z-0"></i>
                </button>
                <button onclick="switchView('history', 'silver')" class="card-glass grad-silver p-3 h-32 flex flex-col justify-between relative overflow-hidden text-left">
                    <div class="flex justify-between items-start z-10">
                        <span class="text-[9px] uppercase font-black text-gray-400 tracking-wider">Silber</span>
                        <span id="silverPL" class="text-[9px] font-bold text-gray-500">0%</span>
                    </div>
                    <div class="z-10">
                        <div id="silverVal" class="text-xl font-bold">•••• €</div>
                        <div class="text-[8px] text-gray-500 mt-1 uppercase tracking-tighter">Tippen für Details</div>
                    </div>
                    <i class="ph-fill ph-coin absolute -bottom-2 -right-2 text-6xl text-gray-500/10 z-0"></i>
                </button>
            </div>
            
            <button onclick="switchView('history', 'etf')" class="card-glass grad-etf p-3 h-24 flex items-center justify-between relative overflow-hidden text-left">
                <div class="z-10">
                    <span class="text-[9px] uppercase font-black text-blue-400 tracking-wider block mb-1">S&P 500 ETF (SXR8)</span>
                    <div id="etfVal" class="text-2xl font-bold">•••• €</div>
                </div>
                <div class="text-right z-10 flex flex-col items-end">
                    <span id="etfPL" class="text-xs font-bold bg-gray-900/50 px-2 py-1 rounded mb-1">0%</span>
                    <span class="text-[8px] text-gray-500 uppercase">Ansehen</span>
                </div>
                <i class="ph-fill ph-chart-line-up absolute top-1/2 -translate-y-1/2 right-10 text-6xl text-blue-500/10 z-0"></i>
            </button>
        </div>

        <div class="flex-1"></div>

        <div class="shrink-0 mt-2 z-20">
            <button onclick="openModal()" class="w-full h-14 bg-white text-black rounded-2xl text-xs font-bold uppercase tracking-widest flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform">
                <i class="ph-bold ph-plus-circle text-xl"></i> Neuer Kauf eintragen
            </button>
        </div>
        
        <div class="text-center mt-3 pb-safe z-10">
            <span id="lastUpdateLabel" class="text-[8px] text-gray-700 font-mono">Stand: --:--</span>
        </div>
    </div>


    <div id="viewHistory" class="view-section bg-black px-4 py-6">
        <div class="flex items-center justify-between mb-6 shrink-0">
            <div>
                <h2 id="historyTitle" class="text-2xl font-bold text-white uppercase tracking-tight">Käufe</h2>
                <p id="historySubtitle" class="text-[10px] text-gray-500 font-bold uppercase tracking-widest"></p>
            </div>
            <button onclick="switchView('dashboard')" class="w-10 h-10 rounded-full bg-[#1c1c1e] border border-gray-800 text-white flex items-center justify-center active:scale-90"><i class="ph-bold ph-x"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto no-scrollbar space-y-3 pb-10" id="historyList">
            </div>
    </div>


    <div id="entryModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[#111] border border-[#333] w-full max-w-sm rounded-2xl p-5 shadow-2xl animate-fade-in-up">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-white font-bold text-sm uppercase">Kauf Details</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            <div class="space-y-3">
                <div class="grid grid-cols-3 gap-2">
                    <select id="inpCat" onchange="updateUI()" class="col-span-1 h-10 px-2 text-xs font-bold text-center"><option value="gold">Gold</option><option value="silver">Silber</option><option value="etf">ETF</option></select>
                    <input type="text" id="inpProd" placeholder="Name" class="col-span-2 h-10 px-3 text-sm">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-[9px] text-yellow-500 uppercase block mb-1">Kaufpreis (€)</label>
                        <input type="number" id="inpAmt" placeholder="0.00" step="0.01" class="w-full h-10 px-3 text-sm font-bold border-yellow-500/50">
                    </div>
                    <div>
                        <label id="lblWeight" class="text-[9px] text-gray-500 uppercase block mb-1">Menge / Gramm</label>
                        <div class="relative">
                            <input type="number" id="inpWgt" placeholder="0.00" step="0.0001" class="w-full h-10 pl-3 pr-8 text-sm">
                            <button onclick="autoCalcShares()" class="absolute right-0 top-0 h-10 w-8 flex items-center justify-center text-blue-400 hover:text-white"><i class="ph-fill ph-magic-wand"></i></button>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="inpLoc" placeholder="Wo gekauft?" class="h-10 px-3 text-xs">
                    <input type="date" id="inpDate" class="h-10 px-2 text-xs text-center">
                </div>
            </div>
            <div class="mt-6 flex gap-2">
                <button id="btnDelete" onclick="deleteEntry()" class="hidden w-1/3 h-11 bg-red-900/20 text-red-500 rounded-xl text-xs font-bold border border-red-900/30">Löschen</button>
                <button onclick="saveEntry()" class="flex-1 h-11 bg-white text-black rounded-xl text-xs font-bold shadow-lg">Speichern</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-6">
        <div class="bg-[#111] border border-[#333] w-full max-w-sm rounded-2xl p-5 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-white font-bold text-sm uppercase">Backup & Markt</h3>
                <button onclick="closeSettings()" class="text-gray-500 hover:text-white"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-3 gap-2">
                    <input type="number" id="mGold" placeholder="Au €/g" class="h-8 text-center text-[10px]">
                    <input type="number" id="mSilver" placeholder="Ag €/g" class="h-8 text-center text-[10px]">
                    <input type="number" id="mEtf" placeholder="ETF €" class="h-8 text-center text-[10px]">
                </div>
                <button onclick="saveManualPrices()" class="w-full h-8 bg-blue-900/20 text-blue-400 text-[10px] uppercase font-bold rounded">Kurse manuell setzen</button>
                <div class="border-t border-[#222]"></div>
                <div class="flex gap-2">
                    <button onclick="exportBackup()" class="flex-1 h-10 bg-[#222] text-xs text-gray-300 rounded flex items-center justify-center gap-1"><i class="ph-bold ph-download-simple"></i> Sichern</button>
                    <button onclick="document.getElementById('importFile').click()" class="flex-1 h-10 bg-[#222] text-xs text-gray-300 rounded flex items-center justify-center gap-1"><i class="ph-bold ph-upload-simple"></i> Laden</button>
                    <input type="file" id="importFile" accept=".json" class="hidden" onchange="importBackup(this)">
                </div>
            </div>
        </div>
    </div>

    <script>
        let entries = JSON.parse(localStorage.getItem('port_v18_data')) || [];
        if(entries.length === 0 && localStorage.getItem('port_entries_v17')) {
            entries = JSON.parse(localStorage.getItem('port_entries_v17'));
        }
        let prices = JSON.parse(localStorage.getItem('port_v18_prices')) || { gold: 0, silver: 0, etf: 0, lastUpdate: 'Nie' };
        let privacy = false;
        let editId = null;
        let currentFilter = 'all';

        const $ = (id) => document.getElementById(id);

        init();
        function init() {
            $('mGold').value = prices.gold ? prices.gold.toFixed(2) : '';
            $('mSilver').value = prices.silver ? prices.silver.toFixed(2) : '';
            $('mEtf').value = prices.etf ? prices.etf.toFixed(2) : '';
            render();
            forceRefresh();
        }

        async function forceRefresh() {
            const btn = $('iconRefresh'); btn.classList.add('spin-slow');
            const fetchAsset = async (symbol, isMetal) => {
                const urls = [
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d&ts=${Date.now()}`)}`,
                    `https://corsproxy.io/?${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`)}`
                ];
                for(let u of urls) {
                    try {
                        const res = await fetch(u); const json = await res.json();
                        let p = json.chart.result[0].meta.regularMarketPrice;
                        return isMetal ? p / 31.1034768 : p;
                    } catch(e) { continue; }
                }
                return null;
            };
            const [g, s, e] = await Promise.all([fetchAsset('XAUEUR=X', true), fetchAsset('XAGEUR=X', true), fetchAsset('SXR8.DE', false)]);
            if(g) { prices.gold = g; $('mGold').value = g.toFixed(2); }
            if(s) { prices.silver = s; $('mSilver').value = s.toFixed(2); }
            if(e) { prices.etf = e; $('mEtf').value = e.toFixed(2); }
            prices.lastUpdate = new Date().toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});
            $('priceTicker').innerText = `Au: ${prices.gold.toFixed(2)}€/g • Ag: ${prices.silver.toFixed(2)}€/g`;
            localStorage.setItem('port_v18_prices', JSON.stringify(prices));
            render(); btn.classList.remove('spin-slow');
        }

        async function autoCalcShares() {
            const amt = parseFloat($('inpAmt').value); const date = $('inpDate').value; const cat = $('inpCat').value;
            if(!amt || !date) return alert("Daten unvollständig");
            const btn = document.querySelector('.ph-magic-wand').parentElement;
            btn.innerHTML = '<i class="ph-bold ph-spinner spin-slow"></i>';
            try {
                const sym = cat==='etf'?'SXR8.DE':(cat==='gold'?'XAUEUR=X':'XAGEUR=X');
                const ts = Math.floor(new Date(date).getTime() / 1000);
                const res = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${sym}?period1=${ts}&period2=${ts+86400}&interval=1d`)}`);
                const json = await res.json();
                let close = json.chart.result[0].indicators.quote[0].close[0];
                if(cat!=='etf') close = close / 31.1034768;
                $('inpWgt').value = (amt / close).toFixed(4);
            } catch(e) { alert("Kurs nicht gefunden"); }
            btn.innerHTML = '<i class="ph-fill ph-magic-wand"></i>';
        }

        function render() {
            let tInv=0, tVal=0, gVal=0, sVal=0, eVal=0, gInv=0, sInv=0, eInv=0;
            entries.forEach(e => {
                tInv += e.amount;
                let p = (e.category==='gold')?prices.gold:(e.category==='silver'?prices.silver:prices.etf);
                let val = (p > 0.01) ? (e.weight * p) : e.amount;
                if(e.category==='gold'){ gVal+=val; gInv+=e.amount; }
                else if(e.category==='silver'){ sVal+=val; sInv+=e.amount; }
                else { eVal+=val; eInv+=e.amount; }
                tVal += val;
            });
            $('currentValueDisplay').innerText = privacy ? '•••• €' : fmt(tVal);
            const pl = tVal - tInv;
            $('plDisplay').innerText = privacy ? '•••• €' : (pl>=0?'+':'') + fmt(pl);
            $('plPercent').innerText = (tInv>0?((pl/tInv)*100).toFixed(2):'0') + "%";
            $('lastUpdateLabel').innerText = "Stand: " + prices.lastUpdate;
            updateCard('gold', gVal, gInv); updateCard('silver', sVal, sInv); updateCard('etf', eVal, eInv);
        }

        function updateCard(id, curr, inv) {
            const diff = curr - inv; const pct = inv > 0 ? (diff/inv)*100 : 0;
            $(`${id}Val`).innerText = privacy ? '••••' : fmt0(curr);
            $(`${id}PL`).innerText = (diff>=0?'+':'') + pct.toFixed(1) + "%";
            $(`${id}PL`).className = "text-[9px] font-bold " + (diff>=0?"text-green-500":"text-red-500");
        }

        function renderList(filter) {
            const l = $('historyList'); l.innerHTML = '';
            $('historyTitle').innerText = filter === 'all' ? 'Alle Käufe' : filter;
            $('historySubtitle').innerText = filter === 'etf' ? 'iShares S&P 500 (IE00B5BMR087)' : (filter === 'gold' ? 'Feingold (999.9)' : 'Feinsilber');
            
            const filtered = entries.filter(e => filter === 'all' || e.category === filter)
                                    .sort((a,b) => new Date(b.date) - new Date(a.date));

            filtered.forEach(e => {
                let p = (e.category==='gold')?prices.gold:(e.category==='silver'?prices.silver:prices.etf);
                let val = (p>0.01) ? e.weight*p : e.amount;
                let pl = val - e.amount; let col = pl>=0?'text-green-500':'text-red-500';
                let d = document.createElement('div');
                d.className = 'bg-[#111] p-4 rounded-2xl border border-[#222] flex justify-between items-center active:bg-[#222]';
                d.onclick = () => openModal(e.id);
                d.innerHTML = `<div><div class="text-sm font-bold">${e.product}</div><div class="text-[10px] text-gray-500">${new Date(e.date).toLocaleDateString()} • ${e.weight.toFixed(3)} ${e.category==='etf'?'Stk':'g'}</div></div><div class="text-right"><div class="text-sm font-bold text-gray-300">${privacy?'•••':fmt(val)}</div><div class="text-[10px] ${col}">${pl>=0?'+':''}${((pl/e.amount)*100).toFixed(1)}%</div></div>`;
                l.appendChild(d);
            });
        }

        function switchView(v, filter = 'all') {
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
            if(v==='history') { $('viewHistory').classList.add('active'); renderList(filter); }
            else { $('viewDashboard').classList.add('active'); render(); }
        }
        function togglePrivacy() { privacy=!privacy; render(); }
        function openModal(id=null) {
            editId = id; $('entryModal').classList.remove('hidden'); $('entryModal').classList.add('flex');
            if(id) {
                const e = entries.find(x=>x.id===id);
                $('inpCat').value=e.category; $('inpProd').value=e.product; $('inpAmt').value=e.amount; $('inpWgt').value=e.weight; $('inpLoc').value=e.location||''; $('inpDate').value=e.date; $('btnDelete').classList.remove('hidden');
            } else {
                $('inpCat').value='gold'; $('inpProd').value=''; $('inpAmt').value=''; $('inpWgt').value=''; $('inpLoc').value=''; $('inpDate').value=new Date().toISOString().split('T')[0]; $('btnDelete').classList.add('hidden');
            }
            updateUI();
        }
        function updateUI() { $('lblWeight').innerText = $('inpCat').value === 'etf' ? "Anteile (Stück)" : "Menge (Gramm)"; }
        function closeModal() { $('entryModal').classList.remove('flex'); $('entryModal').classList.add('hidden'); editId=null; }
        function saveEntry() {
            const amt = parseFloat($('inpAmt').value); const wgt = parseFloat($('inpWgt').value);
            if(!amt || isNaN(wgt)) return alert("Bitte Werte prüfen");
            const item = { id: editId || Date.now(), category: $('inpCat').value, product: $('inpProd').value || $('inpCat').value.toUpperCase(), amount: amt, weight: wgt, location: $('inpLoc').value, date: $('inpDate').value };
            if(editId) entries = entries.map(x => x.id===editId?item:x); else entries.push(item);
            localStorage.setItem('port_v18_data', JSON.stringify(entries)); closeModal(); render();
            if($('viewHistory').classList.contains('active')) renderList($('historyTitle').innerText.toLowerCase().includes('gold') ? 'gold' : ($('historyTitle').innerText.toLowerCase().includes('silber') ? 'silver' : 'etf'));
        }
        function deleteEntry() { if(confirm("Löschen?")) { entries = entries.filter(x=>x.id!==editId); localStorage.setItem('port_v18_data', JSON.stringify(entries)); closeModal(); render(); if($('viewHistory').classList.contains('active')) renderList('all'); } }
        function openSettings() { $('settingsModal').classList.remove('hidden'); $('settingsModal').classList.add('flex'); }
        function closeSettings() { $('settingsModal').classList.add('hidden'); $('settingsModal').classList.remove('flex'); }
        function saveManualPrices() { prices.gold = parseFloat($('mGold').value); prices.silver = parseFloat($('mSilver').value); prices.etf = parseFloat($('mEtf').value); prices.lastUpdate = "Manuell"; localStorage.setItem('port_v18_prices', JSON.stringify(prices)); render(); closeSettings(); }
        function exportBackup() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({entries, prices})); a.download = "portfolio_backup.json"; a.click(); }
        function importBackup(el) { const r = new FileReader(); r.onload = e => { const d = JSON.parse(e.target.result); entries = d.entries; prices = d.prices; localStorage.setItem('port_v18_data', JSON.stringify(entries)); location.reload(); }; r.readAsText(el.files[0]); }
        function fmt(n) { return new Intl.NumberFormat('de-DE', {style:'currency', currency:'EUR'}).format(n); }
        function fmt0(n) { return new Intl.NumberFormat('de-DE', {style:'currency', currency:'EUR', maximumFractionDigits:0}).format(n); }
    </script>
</body>
</html>
