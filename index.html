<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portfolio V10</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Portfolio">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #ffffff;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        input, select {
            background: #1c1c1e;
            border: 1px solid #2c2c2e;
            color: white;
            transition: all 0.2s ease;
            appearance: none;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #4ade80;
            background: #252527;
        }
        input[type="date"] {
            min-height: 40px;
            display: block;
            color-scheme: dark;
        }
        .bg-card { background: #1c1c1e; }
        
        /* Animations */
        .spin-slow { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Gradients */
        .grad-gold { background: linear-gradient(180deg, rgba(234, 179, 8, 0.15) 0%, rgba(28,28,30,0) 100%); border-top: 2px solid rgba(234, 179, 8, 0.5); }
        .grad-silver { background: linear-gradient(180deg, rgba(209, 213, 219, 0.15) 0%, rgba(28,28,30,0) 100%); border-top: 2px solid rgba(209, 213, 219, 0.5); }
        .grad-etf { background: linear-gradient(180deg, rgba(59, 130, 246, 0.15) 0%, rgba(28,28,30,0) 100%); border-top: 2px solid rgba(59, 130, 246, 0.5); }
        
        .modal-overlay { background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
    </style>
</head>
<body class="h-screen flex flex-col px-4 pt-10 pb-8 bg-black">

    <div class="bg-gray-900 rounded-3xl p-5 mb-4 border border-gray-800 relative overflow-hidden shadow-2xl shrink-0">
        <div id="glow-bg" class="absolute -top-10 -right-10 w-48 h-48 bg-gray-700 rounded-full blur-[80px] opacity-20 pointer-events-none transition-colors duration-700"></div>

        <div class="flex justify-between items-start relative z-10">
            <div>
                <p class="text-gray-500 text-[10px] font-bold uppercase tracking-widest mb-1">Gesamtvermögen</p>
                <h1 id="currentValueDisplay" class="text-4xl font-extrabold tracking-tight text-white">0,00 €</h1>
            </div>
            <button onclick="fetchAllPrices()" id="btnRefresh" class="bg-gray-800/80 p-2 rounded-full text-blue-400 border border-gray-700 active:scale-90 transition-all">
                <i id="iconRefresh" class="ph-bold ph-cloud-arrow-down text-xl"></i>
            </button>
        </div>
        
        <div class="flex items-center gap-3 relative z-10 mt-3">
            <div id="plContainer" class="bg-gray-800/50 px-3 py-1 rounded-lg border border-gray-700 flex items-center gap-2 transition-colors">
                <span id="plDisplay" class="text-sm font-bold text-gray-300">0,00 €</span>
                <span id="plPercent" class="text-[10px] font-bold text-gray-500 bg-black/30 px-1.5 py-0.5 rounded">0%</span>
            </div>
            <span id="sinceDateLabel" class="text-[9px] text-gray-600 font-bold uppercase tracking-wider">Seit Beginn</span>
        </div>
    </div>

    <div class="grid grid-cols-3 gap-2 mb-5 shrink-0">
        <div class="rounded-xl p-2.5 grad-gold relative bg-[#1c1c1e] text-center">
            <div class="text-yellow-500 text-xl mb-1"><i class="ph-fill ph-coins"></i></div>
            <p class="text-[9px] font-bold uppercase text-gray-500">Gold</p>
            <h2 id="goldVal" class="text-sm font-bold text-white my-0.5">0 €</h2>
            <span id="goldPL" class="text-[9px] font-bold text-gray-600">0%</span>
        </div>

        <div class="rounded-xl p-2.5 grad-silver relative bg-[#1c1c1e] text-center">
            <div class="text-gray-300 text-xl mb-1"><i class="ph-fill ph-coin"></i></div>
            <p class="text-[9px] font-bold uppercase text-gray-500">Silber</p>
            <h2 id="silverVal" class="text-sm font-bold text-white my-0.5">0 €</h2>
            <span id="silverPL" class="text-[9px] font-bold text-gray-600">0%</span>
        </div>

        <div class="rounded-xl p-2.5 grad-etf relative bg-[#1c1c1e] text-center">
            <div class="text-blue-500 text-xl mb-1"><i class="ph-fill ph-chart-line-up"></i></div>
            <p class="text-[9px] font-bold uppercase text-gray-500">iShares S&P 500</p>
            <p class="text-[7px] text-gray-600 font-mono mb-0.5">IE00B5BMR087</p>
            <h2 id="etfVal" class="text-sm font-bold text-white my-0.5">0 €</h2>
            <span id="etfPL" class="text-[9px] font-bold text-gray-600">0%</span>
        </div>
    </div>

    <div class="mb-4 shrink-0">
        <button onclick="openModal()" class="w-full py-3 bg-[#1c1c1e] border border-gray-800 rounded-xl text-xs font-bold uppercase tracking-wider text-gray-400 hover:text-white flex items-center justify-center gap-2 active:bg-gray-800 transition-colors shadow-lg">
            <i class="ph-bold ph-plus-circle text-lg"></i> Kauf Hinzufügen
        </button>
    </div>

    <div class="flex-1 overflow-hidden flex flex-col mb-2">
        <h3 class="text-gray-500 text-[10px] font-bold uppercase tracking-widest mb-2 ml-1">Transaktionen</h3>
        <div id="historyList" class="overflow-y-auto no-scrollbar pb-20 space-y-2.5">
            </div>
    </div>

    <div class="pt-3 border-t border-gray-900 shrink-0 pb-safe">
        <div class="flex justify-between items-center px-1">
            <div class="flex gap-4">
                 <button onclick="exportBackup()" class="flex items-center gap-1 text-[10px] font-bold text-gray-600 hover:text-white uppercase"><i class="ph-bold ph-download-simple"></i> Backup</button>
                 <button onclick="document.getElementById('importFile').click()" class="flex items-center gap-1 text-[10px] font-bold text-gray-600 hover:text-white uppercase"><i class="ph-bold ph-upload-simple"></i> Laden</button>
                 <input type="file" id="importFile" accept=".json" style="display:none" onchange="importBackup(this)">
            </div>
            <span id="lastUpdateLabel" class="text-[9px] text-gray-700 font-mono">Warte auf Kurse...</span>
        </div>
    </div>

    <div id="entryModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-[#1c1c1e] w-full max-w-sm rounded-2xl border border-gray-700 shadow-2xl p-5 animate-fade-in-up">
            <div class="flex justify-between items-center mb-5">
                <h3 id="modalTitle" class="text-white font-bold text-lg">Eintrag</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            <div class="space-y-3">
                <div class="flex gap-3">
                    <div class="w-1/3">
                        <label class="text-[10px] text-gray-500 font-bold uppercase">Typ</label>
                        <select id="inpCat" onchange="updateModalLabels()" class="w-full h-10 rounded-lg px-2 text-xs font-bold text-center mt-1">
                            <option value="gold">Gold</option>
                            <option value="silver">Silber</option>
                            <option value="etf">ETF</option>
                        </select>
                    </div>
                    <div class="w-2/3">
                        <label class="text-[10px] text-gray-500 font-bold uppercase">Produkt</label>
                        <input type="text" id="inpProd" placeholder="Name" class="w-full h-10 rounded-lg px-3 text-sm mt-1">
                    </div>
                </div>
                <div class="flex gap-3">
                    <div class="w-1/2">
                        <label class="text-[10px] text-yellow-500 font-bold uppercase">Bezahlt (€)</label>
                        <input type="number" id="inpAmt" placeholder="0.00" step="0.01" inputmode="decimal" class="w-full h-10 rounded-lg px-3 text-base font-bold mt-1 border-gray-600 focus:border-yellow-500">
                    </div>
                    <div class="w-1/2">
                        <label id="lblWeight" class="text-[10px] text-gray-500 font-bold uppercase">Gewicht (g)</label>
                        <input type="number" id="inpWgt" placeholder="0.00" step="0.01" inputmode="decimal" class="w-full h-10 rounded-lg px-3 text-base font-medium mt-1">
                    </div>
                </div>
                <div class="flex gap-3">
                    <div class="w-1/2">
                        <label class="text-[10px] text-gray-500 font-bold uppercase">Wo gekauft?</label>
                        <input type="text" id="inpLoc" placeholder="Händler/Ort" class="w-full h-10 rounded-lg px-3 text-sm mt-1">
                    </div>
                    <div class="w-1/2">
                        <label class="text-[10px] text-gray-500 font-bold uppercase">Datum</label>
                        <input type="date" id="inpDate" class="w-full h-10 rounded-lg px-1 text-xs text-center font-medium mt-1">
                    </div>
                </div>
            </div>
            <div class="mt-6 flex gap-3">
                <button id="btnDelete" onclick="deleteCurrentEntry()" class="hidden w-1/3 h-11 bg-red-500/10 text-red-500 border border-red-500/30 font-bold rounded-xl active:scale-95 transition-transform text-sm">Löschen</button>
                <button onclick="saveEntry()" class="flex-1 h-11 bg-white text-black font-bold rounded-xl active:scale-95 transition-transform text-sm shadow-lg">Speichern</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let entries = JSON.parse(localStorage.getItem('portfolio_entries_v10')) || [];
        // Migration V9 -> V10
        if(entries.length === 0) {
            const v9 = JSON.parse(localStorage.getItem('portfolio_entries_v9'));
            if(v9) { entries = v9; localStorage.setItem('portfolio_entries_v10', JSON.stringify(entries)); }
        }

        let prices = JSON.parse(localStorage.getItem('portfolio_prices_v10')) || { gold: 0, silver: 0, etf: 0, lastUpdate: 'Nie' };
        let currentEditId = null;

        // UI Refs
        const els = {
            totalVal: document.getElementById('currentValueDisplay'),
            plDisplay: document.getElementById('plDisplay'),
            plPercent: document.getElementById('plPercent'),
            plContainer: document.getElementById('plContainer'),
            sinceDate: document.getElementById('sinceDateLabel'),
            list: document.getElementById('historyList'),
            goldVal: document.getElementById('goldVal'), goldPL: document.getElementById('goldPL'),
            silverVal: document.getElementById('silverVal'), silverPL: document.getElementById('silverPL'),
            etfVal: document.getElementById('etfVal'), etfPL: document.getElementById('etfPL'),
            lastUpdate: document.getElementById('lastUpdateLabel'),
            modal: document.getElementById('entryModal'),
            inpCat: document.getElementById('inpCat'), inpProd: document.getElementById('inpProd'),
            inpAmt: document.getElementById('inpAmt'), inpWgt: document.getElementById('inpWgt'),
            inpLoc: document.getElementById('inpLoc'), inpDate: document.getElementById('inpDate'),
            btnDelete: document.getElementById('btnDelete'), lblWeight: document.getElementById('lblWeight')
        };

        // Init
        render();
        document.addEventListener("DOMContentLoaded", fetchAllPrices);
        document.addEventListener("visibilitychange", () => { if (document.visibilityState === 'visible') fetchAllPrices(); });

        // --- FETCHING (EXACT ISIN MATCHING) ---
        async function fetchAllPrices() {
            const icon = document.getElementById('iconRefresh');
            icon.classList.add('ph-spinner', 'spin-slow', 'text-blue-400');
            icon.classList.remove('ph-cloud-arrow-down', 'text-red-500');
            
            // Helper to fetch one safely
            const fetchSafe = async (symbol) => {
                try {
                    // Yahoo Finance API via AllOrigins Proxy
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`;
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                    const res = await fetch(proxyUrl);
                    const data = await res.json();
                    if(!data.contents) return null;
                    const json = JSON.parse(data.contents);
                    return json.chart.result[0].meta.regularMarketPrice;
                } catch(e) { console.error(symbol, e); return null; }
            };

            // Fetch independently (Parallel)
            // SXR8.DE corresponds to ISIN IE00B5BMR087 on Xetra in EUR
            const [g, s, e] = await Promise.all([
                fetchSafe('XAUEUR=X'), // Gold in EUR
                fetchSafe('XAGEUR=X'), // Silver in EUR
                fetchSafe('SXR8.DE')   // iShares Core S&P 500 UCITS ETF (Acc) in EUR
            ]);

            // Only update if we got a real number
            if(g) prices.gold = g / 31.1034768; 
            if(s) prices.silver = s / 31.1034768;
            if(e) prices.etf = e;

            const now = new Date();
            prices.lastUpdate = now.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});
            
            localStorage.setItem('portfolio_prices_v10', JSON.stringify(prices));
            render();

            icon.classList.remove('ph-spinner', 'spin-slow');
            icon.classList.add('ph-check', 'text-green-500');
            setTimeout(() => {
                icon.classList.remove('ph-check', 'text-green-500');
                icon.classList.add('ph-cloud-arrow-down', 'text-blue-400');
            }, 2000);
        }

        // --- RENDER ---
        function render() {
            let tInv=0, tVal=0;
            let gInv=0, gVal=0; 
            let sInv=0, sVal=0;
            let eInv=0, eVal=0;
            let oldestDate = null;

            els.list.innerHTML = '';
            els.lastUpdate.innerText = "Stand: " + prices.lastUpdate;

            if(entries.length === 0) {
                els.list.innerHTML = '<div class="text-center text-gray-700 mt-10 text-xs uppercase tracking-widest">Keine Positionen</div>';
                els.sinceDate.innerText = "Seit Beginn";
            } else {
                // Find oldest date
                const sortedByDate = [...entries].sort((a,b) => new Date(a.date) - new Date(b.date));
                const d = new Date(sortedByDate[0].date);
                els.sinceDate.innerText = "Seit " + d.toLocaleDateString('de-DE');
            }

            entries.forEach(e => {
                tInv += e.amount;
                
                let val = 0;
                let priceUsed = 0;

                if(e.category === 'gold') { priceUsed = prices.gold; gInv += e.amount; }
                else if(e.category === 'silver') { priceUsed = prices.silver; sInv += e.amount; }
                else if(e.category === 'etf') { priceUsed = prices.etf; eInv += e.amount; }

                // Fallback Logic
                if(priceUsed > 0) {
                    val = e.weight * priceUsed;
                } else {
                    val = e.amount; 
                }

                if(e.category === 'gold') gVal += val;
                else if(e.category === 'silver') sVal += val;
                else if(e.category === 'etf') eVal += val;
                
                tVal += val;

                // List Item
                const pl = val - e.amount;
                const plP = e.amount > 0 ? (pl/e.amount)*100 : 0;
                const col = pl >= 0 ? 'text-green-500' : 'text-red-500';
                
                let icon = 'ph-coins'; let iconCol = 'text-yellow-500';
                if(e.category === 'silver') { icon = 'ph-coin'; iconCol = 'text-gray-300'; }
                if(e.category === 'etf') { icon = 'ph-chart-line-up'; iconCol = 'text-blue-500'; }

                const dateStr = new Date(e.date).toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'2-digit'});
                const locStr = e.location ? `<span class="flex items-center gap-1"><i class="ph-fill ph-map-pin text-[10px]"></i> ${e.location}</span>` : '';

                const el = document.createElement('div');
                el.onclick = () => openModal(e.id);
                el.className = 'bg-[#1c1c1e] p-3 rounded-xl border border-[#2c2c2e] flex items-center gap-3 active:bg-gray-800 transition-colors cursor-pointer';
                el.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-xl shrink-0 ${iconCol}">
                        <i class="ph-fill ${icon}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline mb-0.5">
                            <h4 class="text-white font-bold text-sm truncate pr-2">${e.product}</h4>
                            <span class="text-white font-bold text-sm">${fmt(val)}</span>
                        </div>
                        <div class="flex justify-between items-center text-[11px] text-gray-500">
                            <div class="flex items-center gap-3">
                                <span>${dateStr}</span>
                                ${locStr}
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-600">${fmt0(e.amount)}</span>
                                <span class="font-bold ${col}">${pl >= 0 ? '+' : ''}${plP.toFixed(1)}%</span>
                            </div>
                        </div>
                    </div>
                    <i class="ph-bold ph-pencil-simple text-gray-700"></i>
                `;
                els.list.appendChild(el);
            });

            // Update Header
            els.totalVal.innerText = fmt(tVal);
            const totalPL = tVal - tInv;
            const totalPLP = tInv > 0 ? (totalPL/tInv)*100 : 0;
            
            els.plDisplay.innerText = (totalPL >= 0 ? "+" : "") + fmt(totalPL);
            els.plPercent.innerText = (totalPL >= 0 ? "+" : "") + totalPLP.toFixed(2) + "%";
            
            // Header Color
            if(totalPL >= 0) {
                els.plContainer.className = "bg-green-500/10 px-3 py-1 rounded-lg border border-green-500/30 flex items-center gap-2";
                els.plDisplay.className = "text-sm font-bold text-green-400";
                els.plPercent.className = "text-[10px] font-bold text-green-300 bg-green-500/20 px-1.5 py-0.5 rounded";
                document.getElementById('glow-bg').className = "absolute -top-10 -right-10 w-48 h-48 bg-green-500 rounded-full blur-[80px] opacity-20 pointer-events-none transition-colors duration-700";
            } else {
                els.plContainer.className = "bg-red-500/10 px-3 py-1 rounded-lg border border-red-500/30 flex items-center gap-2";
                els.plDisplay.className = "text-sm font-bold text-red-400";
                els.plPercent.className = "text-[10px] font-bold text-red-300 bg-red-500/20 px-1.5 py-0.5 rounded";
                document.getElementById('glow-bg').className = "absolute -top-10 -right-10 w-48 h-48 bg-red-500 rounded-full blur-[80px] opacity-20 pointer-events-none transition-colors duration-700";
            }

            // Update Columns
            updateCard(els.goldVal, els.goldPL, gVal, gInv);
            updateCard(els.silverVal, els.silverPL, sVal, sInv);
            updateCard(els.etfVal, els.etfPL, eVal, eInv);
        }

        function updateCard(elVal, elPL, curr, inv) {
            const diff = curr - inv;
            const pct = inv > 0 ? (diff/inv)*100 : 0;
            elVal.innerText = fmt0(curr);
            elPL.innerText = (diff >= 0 ? "+" : "") + pct.toFixed(1) + "%";
            elPL.className = diff >= 0 ? "text-[9px] font-bold text-green-500" : "text-[9px] font-bold text-red-500";
        }

        // --- ACTIONS ---
        function openModal(id = null) {
            currentEditId = id;
            els.modal.classList.remove('hidden'); els.modal.classList.add('flex');
            if(id) {
                const e = entries.find(x => x.id === id);
                document.getElementById('modalTitle').innerText = "Bearbeiten";
                els.btnDelete.classList.remove('hidden');
                els.inpCat.value = e.category; els.inpProd.value = e.product;
                els.inpAmt.value = e.amount; els.inpWgt.value = e.weight;
                els.inpLoc.value = e.location || ''; els.inpDate.value = e.date;
            } else {
                document.getElementById('modalTitle').innerText = "Neu";
                els.btnDelete.classList.add('hidden');
                els.inpCat.value = 'gold'; els.inpProd.value = '';
                els.inpAmt.value = ''; els.inpWgt.value = '';
                els.inpLoc.value = ''; els.inpDate.value = new Date().toISOString().split('T')[0];
            }
            updateModalLabels();
        }
        function closeModal() { els.modal.classList.add('hidden'); els.modal.classList.remove('flex'); currentEditId = null; }
        
        function updateModalLabels() {
            if(els.inpCat.value === 'etf') { 
                els.lblWeight.innerText = "Anzahl (Stk)"; 
                els.inpWgt.placeholder="2.5";
                // Auto-fill Name for ETF
                if(els.inpProd.value === '') els.inpProd.value = "iShares S&P 500";
            } else { 
                els.lblWeight.innerText = "Gewicht (g)"; 
                els.inpWgt.placeholder="31.1"; 
                if(els.inpProd.value === "iShares S&P 500") els.inpProd.value = "";
            }
        }
        
        function saveEntry() {
            const amt = parseFloat(els.inpAmt.value);
            const wgt = parseFloat(els.inpWgt.value);
            if(!amt || amt <= 0) { alert("Preis fehlt!"); return; }
            
            const cat = els.inpCat.value;
            let prod = els.inpProd.value.trim();
            if(!prod) prod = cat === 'etf' ? "iShares S&P 500" : (cat==='gold'?"Gold":"Silber");

            const item = {
                id: currentEditId || Date.now(),
                amount: amt, weight: wgt || 0, category: cat,
                product: prod, location: els.inpLoc.value.trim(), date: els.inpDate.value
            };

            if(currentEditId) {
                const idx = entries.findIndex(x => x.id === currentEditId);
                entries[idx] = item;
            } else {
                entries.unshift(item);
            }
            // Sort Newest First
            entries.sort((a,b) => new Date(b.date) - new Date(a.date));
            localStorage.setItem('portfolio_entries_v10', JSON.stringify(entries));
            render(); closeModal();
        }
        function deleteCurrentEntry() {
            if(confirm("Löschen?")) {
                entries = entries.filter(x => x.id !== currentEditId);
                localStorage.setItem('portfolio_entries_v10', JSON.stringify(entries));
                render(); closeModal();
            }
        }
        function exportBackup() {
            const d = {entries, prices, version:'v10'};
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(d));
            a.download = "portfolio_backup.json"; a.click();
        }
        function importBackup(inp) {
            const f = inp.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                try {
                    const d = JSON.parse(e.target.result);
                    if(confirm("Daten überschreiben?")) {
                        if(d.entries) entries = d.entries;
                        if(d.prices) prices = d.prices;
                        localStorage.setItem('portfolio_entries_v10', JSON.stringify(entries));
                        localStorage.setItem('portfolio_prices_v10', JSON.stringify(prices));
                        location.reload();
                    }
                } catch(err) { alert("Fehler"); }
            };
            r.readAsText(f);
        }
        function fmt(n) { return new Intl.NumberFormat('de-DE', {style:'currency', currency:'EUR'}).format(n); }
        function fmt0(n) { return new Intl.NumberFormat('de-DE', {style:'currency', currency:'EUR', maximumFractionDigits:0}).format(n); }
    </script>
</body>
</html>
