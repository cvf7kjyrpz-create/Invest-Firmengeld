<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portfolio Tracker</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Portfolio">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #ffffff;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        input, select {
            background: #1c1c1e;
            border: 1px solid #2c2c2e;
            color: white;
            transition: all 0.2s ease;
            appearance: none;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #4ade80;
            background: #252527;
        }
        input::placeholder { color: #52525b; }
        input[type="date"] { color-scheme: dark; }

        .bg-card { background: #1c1c1e; }
        
        /* Loading Animation */
        .spin-slow { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .entry-item { transition: all 0.2s ease; }
        .entry-item.deleting { transform: translateX(-100%); opacity: 0; }
        
        /* Specific Gradients for the Split Cards */
        .gradient-gold { background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(0,0,0,0)); }
        .gradient-blue { background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(0,0,0,0)); }
    </style>
</head>
<body class="h-screen flex flex-col px-4 pt-10 pb-6 bg-black">

    <div class="bg-gray-900 rounded-2xl p-5 mb-4 border border-gray-800 relative overflow-hidden shadow-2xl">
        <div id="glow-bg" class="absolute top-0 right-0 w-40 h-40 bg-blue-600 rounded-full blur-[70px] opacity-20 pointer-events-none transition-colors duration-500"></div>

        <div class="flex justify-between items-start mb-2 relative z-10">
            <div>
                <p class="text-gray-400 text-[10px] font-bold uppercase tracking-wider mb-1">Gesamtvermögen</p>
                <h1 id="currentValueDisplay" class="text-4xl font-extrabold tracking-tight text-white">0,00 €</h1>
            </div>
            
            <button onclick="fetchLivePrices()" id="btnRefresh" class="bg-gray-800 p-2 rounded-full text-blue-400 hover:text-white transition-all shadow-lg border border-gray-700 active:scale-90">
                <i id="iconRefresh" class="ph-bold ph-cloud-arrow-down text-lg"></i>
            </button>
        </div>
        
        <div class="flex justify-between items-end relative z-10 mt-2">
            <div>
                 <p class="text-gray-500 text-[10px] font-bold uppercase tracking-wider">Investiert Total</p>
                 <p id="investedDisplay" class="text-gray-300 font-semibold text-sm">0,00 €</p>
            </div>
            <div class="text-right">
                <div id="plDisplay" class="text-lg font-bold text-gray-500">0,00 €</div>
                <div id="plPercent" class="text-xs font-medium text-gray-500">0,00%</div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-6">
        <div class="bg-card rounded-xl p-3 border border-gray-800 gradient-gold relative overflow-hidden">
            <div class="flex items-center gap-2 mb-2">
                <i class="ph-fill ph-coins text-yellow-500"></i>
                <span class="text-[10px] font-bold uppercase text-gray-400">Edelmetalle</span>
            </div>
            <h2 id="metalValueDisplay" class="text-xl font-bold text-white mb-1">0 €</h2>
            <div class="flex justify-between items-end">
                <span class="text-[10px] text-gray-500">Gold & Silber</span>
                <span id="metalPLDisplay" class="text-xs font-bold text-gray-500">0%</span>
            </div>
        </div>

        <div class="bg-card rounded-xl p-3 border border-gray-800 gradient-blue relative overflow-hidden">
            <div class="flex items-center gap-2 mb-2">
                <i class="ph-fill ph-chart-line-up text-blue-500"></i>
                <span class="text-[10px] font-bold uppercase text-gray-400">Aktien / ETF</span>
            </div>
            <h2 id="etfValueDisplay" class="text-xl font-bold text-white mb-1">0 €</h2>
            <div class="flex justify-between items-end">
                <span class="text-[10px] text-gray-500">S&P 500</span>
                <span id="etfPLDisplay" class="text-xs font-bold text-gray-500">0%</span>
            </div>
        </div>
    </div>

    <div id="marketSettings" class="hidden">
        <input type="number" id="priceGold">
        <input type="number" id="priceSilver">
        <input type="number" id="priceEtf">
        <span id="lastUpdateLabel"></span>
    </div>

    <div class="bg-card p-4 rounded-xl mb-6 shadow-lg border border-gray-800">
        <div class="flex flex-col gap-3">
            <div class="flex gap-3">
                <div class="w-1/3">
                    <label class="text-[10px] text-gray-500 font-bold ml-1 uppercase">Typ</label>
                    <select id="inputCategory" onchange="updateLabels()" class="w-full h-10 rounded-lg px-2 text-xs mt-1 font-bold text-center">
                        <option value="gold">Gold</option>
                        <option value="silver">Silber</option>
                        <option value="etf">S&P 500</option>
                    </select>
                </div>
                <div class="w-2/3">
                    <label class="text-[10px] text-gray-500 font-bold ml-1 uppercase">Name / Notiz</label>
                    <input type="text" id="inputProduct" placeholder="z.B. Maple Leaf" class="w-full h-10 rounded-lg px-3 text-sm mt-1">
                </div>
            </div>

            <div class="flex gap-3">
                <div class="w-1/2">
                    <label class="text-[10px] text-gray-500 font-bold ml-1 uppercase">Bezahlt (€)</label>
                    <input type="number" id="inputAmount" placeholder="0.00" step="0.01" inputmode="decimal" class="w-full h-10 rounded-lg px-3 text-base font-bold mt-1">
                </div>
                <div class="w-1/2">
                    <label id="labelWeight" class="text-[10px] text-gray-500 font-bold ml-1 uppercase">Gewicht (Gramm)</label>
                    <input type="number" id="inputWeight" placeholder="0.00" step="0.01" inputmode="decimal" class="w-full h-10 rounded-lg px-3 text-base font-medium mt-1">
                </div>
            </div>

            <div class="flex gap-3">
                <div class="w-1/2">
                    <label class="text-[10px] text-gray-500 font-bold ml-1 uppercase">Ort (Optional)</label>
                    <input type="text" id="inputLocation" placeholder="Händler" class="w-full h-10 rounded-lg px-3 text-xs mt-1">
                </div>
                <div class="w-1/2">
                    <label class="text-[10px] text-gray-500 font-bold ml-1 uppercase">Datum</label>
                    <input type="date" id="inputDate" class="w-full h-10 rounded-lg px-2 text-xs mt-1 text-center font-medium">
                </div>
            </div>

            <button onclick="addEntry()" class="w-full h-11 mt-1 bg-white text-black font-bold rounded-lg active:scale-95 transition-transform flex items-center justify-center gap-2 text-sm hover:bg-gray-200">
                <i class="ph-bold ph-plus"></i> Hinzufügen
            </button>
        </div>
    </div>

    <div class="flex-1 overflow-hidden flex flex-col">
        <h3 class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-3 ml-1">Portfolio Bestand</h3>
        <div id="historyList" class="overflow-y-auto no-scrollbar pb-10 space-y-2.5">
            </div>
    </div>

    <script>
        // --- Data Handling ---
        let entries = JSON.parse(localStorage.getItem('portfolio_entries_v5')) || [];
        let marketPrices = JSON.parse(localStorage.getItem('portfolio_prices_v5')) || { gold: 0, silver: 0, etf: 0, lastUpdate: 'Nie' };

        // DOM Elements - Main
        const elCurrentValue = document.getElementById('currentValueDisplay');
        const elInvested = document.getElementById('investedDisplay');
        const elPL = document.getElementById('plDisplay');
        const elPLPercent = document.getElementById('plPercent');
        
        // DOM Elements - Split Cards
        const elMetalValue = document.getElementById('metalValueDisplay');
        const elMetalPL = document.getElementById('metalPLDisplay');
        const elEtfValue = document.getElementById('etfValueDisplay');
        const elEtfPL = document.getElementById('etfPLDisplay');

        const elHistory = document.getElementById('historyList');
        const elLastUpdate = document.getElementById('lastUpdateLabel');
        
        // Inputs
        const inpProduct = document.getElementById('inputProduct');
        const inpCategory = document.getElementById('inputCategory');
        const inpAmount = document.getElementById('inputAmount');
        const inpWeight = document.getElementById('inputWeight'); 
        const inpLocation = document.getElementById('inputLocation');
        const inpDate = document.getElementById('inputDate');
        
        // Price Inputs (Hidden)
        const inpPriceGold = document.getElementById('priceGold');
        const inpPriceSilver = document.getElementById('priceSilver');
        const inpPriceEtf = document.getElementById('priceEtf');

        // Init
        inpPriceGold.value = marketPrices.gold ? marketPrices.gold.toFixed(2) : '';
        inpPriceSilver.value = marketPrices.silver ? marketPrices.silver.toFixed(2) : '';
        inpPriceEtf.value = marketPrices.etf ? marketPrices.etf.toFixed(2) : '';
        if(elLastUpdate) elLastUpdate.innerText = "Update: " + marketPrices.lastUpdate;
        
        updateLabels(); 
        render();

        // --- AUTO UPDATE LOGIC ---
        document.addEventListener("DOMContentLoaded", () => { fetchLivePrices(); });
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === 'visible') fetchLivePrices();
        });

        // --- FETCHING LIVE DATA ---
        async function fetchLivePrices() {
            const icon = document.getElementById('iconRefresh');
            
            icon.classList.remove('ph-cloud-arrow-down', 'text-red-500');
            icon.classList.add('ph-spinner', 'spin-slow', 'text-blue-400');
            
            try {
                const fetchSymbol = async (symbol) => {
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`;
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    const data = await response.json();
                    if(!data.contents) throw new Error("No data");
                    const json = JSON.parse(data.contents);
                    return json.chart.result[0].meta.regularMarketPrice;
                };

                const [goldPriceOz, silverPriceOz, etfPrice] = await Promise.all([
                    fetchSymbol('XAUEUR=X'),
                    fetchSymbol('XAGEUR=X'),
                    fetchSymbol('SXR8.DE') 
                ]);

                const goldPriceGram = goldPriceOz / 31.1034768;
                const silverPriceGram = silverPriceOz / 31.1034768;

                inpPriceGold.value = goldPriceGram.toFixed(2);
                inpPriceSilver.value = silverPriceGram.toFixed(2);
                inpPriceEtf.value = etfPrice.toFixed(2);
                
                const now = new Date();
                const timeString = now.toLocaleTimeString('de-DE', {hour: '2-digit', minute:'2-digit'});

                savePrices(timeString); 

                icon.classList.remove('ph-spinner', 'spin-slow');
                icon.classList.add('ph-check', 'text-green-500');
                
                setTimeout(() => {
                    icon.classList.remove('ph-check', 'text-green-500');
                    icon.classList.add('ph-cloud-arrow-down', 'text-blue-400');
                }, 2000);

            } catch (error) {
                console.error("Fetch Error:", error);
                icon.classList.remove('ph-spinner', 'spin-slow', 'text-blue-400');
                icon.classList.add('ph-warning', 'text-red-500');
            }
        }

        function updateLabels() {
            const cat = inpCategory.value;
            const label = document.getElementById('labelWeight');
            if (cat === 'etf') {
                label.innerText = 'Anzahl (Anteile)';
                inpWeight.placeholder = "z.B. 2.5";
            } else {
                label.innerText = 'Gewicht (Gramm)';
                inpWeight.placeholder = "z.B. 31.1";
            }
        }

        function savePrices(timestampOverride) {
            marketPrices.gold = parseFloat(inpPriceGold.value) || 0;
            marketPrices.silver = parseFloat(inpPriceSilver.value) || 0;
            marketPrices.etf = parseFloat(inpPriceEtf.value) || 0;
            if(timestampOverride) marketPrices.lastUpdate = timestampOverride;
            
            localStorage.setItem('portfolio_prices_v5', JSON.stringify(marketPrices));
            render(); 
        }

        function addEntry() {
            const amount = parseFloat(inpAmount.value);
            const weight = parseFloat(inpWeight.value);
            const category = inpCategory.value;
            const product = inpProduct.value.trim();
            const location = inpLocation.value.trim();
            const dateVal = inpDate.value; 

            if (!amount || amount <= 0) { alert("Bitte einen Kaufpreis eingeben."); return; }
            
            let finalProduct = product;
            if(!finalProduct) {
                if(category === 'etf') finalProduct = "S&P 500 ETF";
                else if(category === 'gold') finalProduct = "Gold";
                else finalProduct = "Silber";
            }

            const newEntry = {
                id: Date.now(),
                amount: amount,
                weight: weight || 0,
                category: category,
                product: finalProduct,
                location: location || '',
                date: dateVal ? dateVal : null 
            };

            entries.unshift(newEntry);
            entries.sort((a, b) => {
                if (a.date && b.date) return new Date(b.date) - new Date(a.date);
                if (!a.date && b.date) return -1; 
                return 0;
            });

            saveAndRender();
            
            inpAmount.value = '';
            inpWeight.value = '';
            inpProduct.value = '';
            inpLocation.value = '';
            inpDate.value = ''; 
            inpProduct.focus();
        }

        function deleteEntry(id) {
            if(confirm('Eintrag entfernen?')) {
                document.getElementById(`entry-${id}`).classList.add('deleting');
                setTimeout(() => {
                    entries = entries.filter(e => e.id !== id);
                    saveAndRender();
                }, 200);
            }
        }

        function saveAndRender() {
            localStorage.setItem('portfolio_entries_v5', JSON.stringify(entries));
            render();
        }

        function formatCurrency(num) {
            return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(num);
        }
        function formatCurrencyDec(num) {
            return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(num);
        }
        function formatDate(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: '2-digit' });
        }

        function render() {
            let totalInvested = 0;
            let currentPortfolioValue = 0;
            
            // Split Calc
            let metalInvested = 0;
            let metalCurrent = 0;
            let etfInvested = 0;
            let etfCurrent = 0;

            entries.forEach(e => {
                totalInvested += e.amount;
                let entryValue = 0;
                let isMetal = (e.category === 'gold' || e.category === 'silver');
                
                if (e.category === 'gold') entryValue = e.weight * marketPrices.gold;
                else if (e.category === 'silver') entryValue = e.weight * marketPrices.silver;
                else if (e.category === 'etf') entryValue = e.weight * marketPrices.etf;
                
                // Fallback for empty prices
                if (entryValue === 0 && (!marketPrices[e.category] || marketPrices[e.category] === 0)) {
                    entryValue = e.amount; 
                }

                currentPortfolioValue += entryValue;
                e.calculatedValue = entryValue; 

                // Split Logic
                if (isMetal) {
                    metalInvested += e.amount;
                    metalCurrent += entryValue;
                } else {
                    etfInvested += e.amount;
                    etfCurrent += entryValue;
                }
            });

            // 1. UPDATE MAIN TOTAL
            elInvested.innerText = formatCurrencyDec(totalInvested);
            elCurrentValue.innerText = formatCurrencyDec(currentPortfolioValue);

            const profitLoss = currentPortfolioValue - totalInvested;
            const plPercent = totalInvested > 0 ? (profitLoss / totalInvested) * 100 : 0;

            elPL.innerText = (profitLoss >= 0 ? "+" : "") + formatCurrencyDec(profitLoss);
            elPLPercent.innerText = (profitLoss >= 0 ? "+" : "") + plPercent.toFixed(2) + "%";

            // Main Glow & Colors
            const glow = document.getElementById('glow-bg');
            if(profitLoss >= 0) {
                elPL.className = "text-lg font-bold text-green-500";
                elPLPercent.className = "text-xs font-medium text-green-500 bg-green-500/10 px-2 py-0.5 rounded-full inline-block";
                glow.className = "absolute top-0 right-0 w-40 h-40 bg-green-500 rounded-full blur-[70px] opacity-20 pointer-events-none transition-colors duration-500";
            } else {
                elPL.className = "text-lg font-bold text-red-500";
                elPLPercent.className = "text-xs font-medium text-red-500 bg-red-500/10 px-2 py-0.5 rounded-full inline-block";
                glow.className = "absolute top-0 right-0 w-40 h-40 bg-red-500 rounded-full blur-[70px] opacity-20 pointer-events-none transition-colors duration-500";
            }

            // 2. UPDATE SPLIT CARDS
            // Metals
            const metalPL = metalCurrent - metalInvested;
            const metalPLP = metalInvested > 0 ? (metalPL / metalInvested) * 100 : 0;
            elMetalValue.innerText = formatCurrencyDec(metalCurrent);
            elMetalPL.innerText = (metalPL >= 0 ? "+" : "") + metalPLP.toFixed(1) + "%";
            elMetalPL.className = metalPL >= 0 ? "text-xs font-bold text-green-500" : "text-xs font-bold text-red-500";

            // ETF
            const etfPL = etfCurrent - etfInvested;
            const etfPLP = etfInvested > 0 ? (etfPL / etfInvested) * 100 : 0;
            elEtfValue.innerText = formatCurrencyDec(etfCurrent);
            elEtfPL.innerText = (etfPL >= 0 ? "+" : "") + etfPLP.toFixed(1) + "%";
            elEtfPL.className = etfPL >= 0 ? "text-xs font-bold text-green-500" : "text-xs font-bold text-red-500";


            // 3. RENDER LIST
            elHistory.innerHTML = '';
            if (entries.length === 0) {
                elHistory.innerHTML = '<div class="text-center text-gray-800 mt-8 text-xs">Dein Portfolio ist leer.</div>';
                return;
            }

            entries.forEach(entry => {
                let iconClass = 'ph-coins';
                let colorClass = 'text-yellow-500';
                let unitLabel = 'g';
                
                if(entry.category === 'silver') { iconClass = 'ph-coin'; colorClass = 'text-gray-400'; }
                if(entry.category === 'etf') { iconClass = 'ph-chart-line-up'; colorClass = 'text-blue-500'; unitLabel = ' Stk'; }

                const entryPL = entry.calculatedValue - entry.amount;
                const isProfit = entryPL >= 0;
                const plColor = isProfit ? 'text-green-500' : 'text-red-500';
                
                let metaString = '';
                if (entry.location) metaString += `<span class="mr-2"><i class="ph-bold ph-map-pin"></i> ${entry.location}</span>`;
                if (entry.date) metaString += `<span><i class="ph-bold ph-calendar-blank"></i> ${formatDate(entry.date)}</span>`;

                const div = document.createElement('div');
                div.id = `entry-${entry.id}`;
                div.className = 'entry-item bg-gray-900 p-3 rounded-xl flex items-center justify-between border border-gray-800 hover:border-gray-700';
                
                div.innerHTML = `
                    <div class="flex items-center gap-3 w-full overflow-hidden">
                        <div class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center shrink-0">
                            <i class="ph ${iconClass} ${colorClass} text-xl"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-baseline">
                                <h4 class="text-white font-semibold text-sm truncate">${entry.product}</h4>
                                <span class="text-white font-bold text-sm">${formatCurrencyDec(entry.calculatedValue)}</span>
                            </div>
                            <div class="flex justify-between items-center mt-0.5">
                                <div class="flex items-center gap-2 text-[11px] text-gray-400">
                                    <span class="bg-gray-800 px-1.5 py-0.5 rounded text-gray-300 font-mono">${entry.weight}${unitLabel}</span>
                                    <span>Kauf: ${formatCurrencyDec(entry.amount)}</span>
                                </div>
                                <span class="text-[10px] font-bold ${plColor}">
                                    ${isProfit ? '▲' : '▼'} ${formatCurrencyDec(Math.abs(entryPL))}
                                </span>
                            </div>
                            ${metaString ? `<div class="mt-2 pt-2 border-t border-gray-800 text-[10px] text-gray-500 flex items-center">${metaString}</div>` : ''}
                        </div>
                    </div>
                    <button onclick="deleteEntry(${entry.id})" class="ml-3 pl-3 border-l border-gray-800 text-gray-600 hover:text-red-500 h-8 flex items-center">
                        <i class="ph-bold ph-trash"></i>
                    </button>
                `;
                elHistory.appendChild(div);
            });
        }
    </script>
</body>
</html>
