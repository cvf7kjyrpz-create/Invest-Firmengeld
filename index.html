<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portfolio V16</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Portfolio">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #ffffff;
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* No scrolling on main page */
            display: flex;
            flex-direction: column;
        }

        /* Compact Inputs */
        input, select {
            background: #111;
            border: 1px solid #333;
            color: white;
            border-radius: 8px;
            appearance: none;
        }
        input:focus, select:focus { outline: none; border-color: #fff; }
        
        /* Animations */
        .spin-slow { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Gradients */
        .grad-gold { background: linear-gradient(135deg, rgba(234, 179, 8, 0.2), rgba(0,0,0,0)); border: 1px solid rgba(234, 179, 8, 0.3); }
        .grad-silver { background: linear-gradient(135deg, rgba(209, 213, 219, 0.2), rgba(0,0,0,0)); border: 1px solid rgba(209, 213, 219, 0.3); }
        .grad-etf { background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(0,0,0,0)); border: 1px solid rgba(59, 130, 246, 0.3); }

        .view-section { display: none; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; }
        .modal-overlay { background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
    </style>
</head>
<body class="text-white">

    <div id="viewDashboard" class="view-section active px-4 py-6">
        
        <div class="flex justify-between items-center mb-4 shrink-0 h-10">
            <button onclick="togglePrivacy()" class="text-gray-500 hover:text-white p-2"><i id="iconPrivacy" class="ph-bold ph-eye text-xl"></i></button>
            <div class="flex gap-2">
                <button onclick="fetchAllPrices()" class="text-blue-400 p-2"><i id="iconRefresh" class="ph-bold ph-arrows-clockwise text-xl"></i></button>
                <button onclick="openSettings()" class="text-gray-500 hover:text-white p-2"><i class="ph-bold ph-gear text-xl"></i></button>
            </div>
        </div>

        <div class="flex flex-col items-center justify-center grow-0 mb-6 relative">
            <div class="text-center z-10">
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1">Gesamtvermögen</p>
                <h1 id="currentValueDisplay" class="text-4xl font-bold text-white mb-2 tracking-tight">•••• €</h1>
                
                <div class="inline-flex items-center bg-[#1c1c1e] rounded-full px-3 py-1 border border-[#333]">
                    <span id="plDisplay" class="text-xs font-bold text-gray-300 mr-2 border-r border-gray-600 pr-2">•••• €</span>
                    <span id="plPercent" class="text-xs font-bold text-gray-500">0%</span>
                </div>
            </div>
            <div class="absolute w-full h-full bg-blue-500/10 blur-[60px] rounded-full pointer-events-none z-0"></div>
        </div>

        <div class="grid grid-cols-1 gap-3 grow-0 mb-4">
            <div class="grid grid-cols-2 gap-3">
                <div class="grad-gold rounded-2xl p-3 relative h-28 flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <i class="ph-fill ph-coins text-yellow-500 text-xl"></i>
                        <span id="goldPL" class="text-[10px] font-bold text-gray-400">0%</span>
                    </div>
                    <div>
                        <span class="text-[9px] uppercase font-bold text-yellow-500/70">Gold</span>
                        <div id="goldVal" class="text-lg font-bold">•••• €</div>
                    </div>
                </div>
                <div class="grad-silver rounded-2xl p-3 relative h-28 flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <i class="ph-fill ph-coin text-gray-300 text-xl"></i>
                        <span id="silverPL" class="text-[10px] font-bold text-gray-400">0%</span>
                    </div>
                    <div>
                        <span class="text-[9px] uppercase font-bold text-gray-400">Silber</span>
                        <div id="silverVal" class="text-lg font-bold">•••• €</div>
                    </div>
                </div>
            </div>
            <div class="grad-etf rounded-2xl p-3 relative h-20 flex items-center justify-between">
                <div class="flex flex-col justify-center">
                    <span class="text-[9px] uppercase font-bold text-blue-400">S&P 500 ETF</span>
                    <div id="etfVal" class="text-xl font-bold">•••• €</div>
                </div>
                <div class="text-right">
                    <i class="ph-fill ph-chart-line-up text-blue-500 text-xl mb-1 block"></i>
                    <span id="etfPL" class="text-[10px] font-bold text-gray-400">0%</span>
                </div>
            </div>
        </div>

        <div class="flex-1"></div>

        <div class="grid grid-cols-2 gap-3 shrink-0 mt-2">
            <button onclick="openModal()" class="h-12 bg-white text-black rounded-xl text-xs font-bold uppercase tracking-wider flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform">
                <i class="ph-bold ph-plus-circle text-lg"></i> Eintrag
            </button>
            <button onclick="switchView('history')" class="h-12 bg-[#1c1c1e] border border-[#333] text-gray-300 rounded-xl text-xs font-bold uppercase tracking-wider flex items-center justify-center gap-2 active:scale-95 transition-transform">
                <i class="ph-bold ph-list text-lg"></i> Käufe
            </button>
        </div>
        
        <div class="text-center mt-2 pb-safe">
            <span id="lastUpdateLabel" class="text-[8px] text-gray-600 font-mono">Stand: --:--</span>
        </div>
    </div>

    <div id="viewHistory" class="view-section bg-black px-4 py-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-white">Historie</h2>
            <button onclick="switchView('dashboard')" class="w-8 h-8 rounded-full bg-[#222] flex items-center justify-center text-white"><i class="ph-bold ph-x"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto no-scrollbar space-y-2 pb-10" id="historyList">
            </div>
    </div>

    <div id="entryModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[#111] border border-[#333] w-full max-w-sm rounded-2xl p-5 shadow-2xl animate-fade-in-up">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-white font-bold text-sm uppercase">Neuer Eintrag</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-white"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            
            <div class="space-y-3">
                <div class="grid grid-cols-3 gap-2">
                    <select id="inpCat" onchange="updateUI()" class="col-span-1 h-10 px-2 text-xs font-bold text-center"><option value="gold">Gold</option><option value="silver">Silber</option><option value="etf">ETF</option></select>
                    <input type="text" id="inpProd" placeholder="Name" class="col-span-2 h-10 px-3 text-sm">
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase block mb-1">Investiert (€)</label>
                        <input type="number" id="inpAmt" placeholder="0.00" step="0.01" class="w-full h-10 px-3 text-sm font-bold border-yellow-500/50">
                    </div>
                    <div>
                        <label id="lblWeight" class="text-[9px] text-gray-500 uppercase block mb-1">Menge / Anteile</label>
                        <div class="relative">
                            <input type="number" id="inpWgt" placeholder="0.00" step="0.0001" class="w-full h-10 pl-3 pr-8 text-sm">
                            <button onclick="autoCalcShares()" class="absolute right-0 top-0 h-10 w-8 flex items-center justify-center text-blue-400 hover:text-white">
                                <i class="ph-fill ph-magic-wand"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="inpLoc" placeholder="Ort (Optional)" class="h-10 px-3 text-xs">
                    <input type="date" id="inpDate" class="h-10 px-2 text-xs text-center">
                </div>
                
                <p class="text-[9px] text-gray-600 text-center leading-tight mt-1">
                    Tipp: Klicke auf <i class="ph-fill ph-magic-wand text-blue-400"></i>, um Anteile anhand des Datums automatisch zu berechnen.
                </p>
            </div>

            <div class="mt-5 flex gap-2">
                <button id="btnDelete" onclick="deleteEntry()" class="hidden w-1/3 h-10 bg-red-900/20 text-red-500 rounded-lg text-xs font-bold border border-red-900/30">Löschen</button>
                <button onclick="saveEntry()" class="flex-1 h-10 bg-white text-black rounded-lg text-xs font-bold shadow-lg">Speichern</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-6">
        <div class="bg-[#111] border border-[#333] w-full max-w-sm rounded-2xl p-5 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-white font-bold text-sm uppercase">Einstellungen</h3>
                <button onclick="closeSettings()" class="text-gray-500 hover:text-white"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <p class="text-[9px] text-gray-500 uppercase font-bold mb-2">Manuelle Preise (Notfall)</p>
                    <div class="grid grid-cols-3 gap-2">
                        <input type="number" id="mGold" placeholder="Gold" class="h-8 text-center text-xs">
                        <input type="number" id="mSilver" placeholder="Silber" class="h-8 text-center text-xs">
                        <input type="number" id="mEtf" placeholder="ETF" class="h-8 text-center text-xs">
                    </div>
                    <button onclick="saveManualPrices()" class="w-full mt-2 h-8 bg-[#222] text-[10px] uppercase text-gray-300 rounded">Preise Erzwingen</button>
                </div>
                <div class="border-t border-[#222]"></div>
                <div class="flex gap-2">
                    <button onclick="exportBackup()" class="flex-1 h-10 bg-[#222] text-xs text-gray-300 rounded flex items-center justify-center gap-1"><i class="ph-bold ph-download-simple"></i> Sichern</button>
                    <button onclick="document.getElementById('importFile').click()" class="flex-1 h-10 bg-[#222] text-xs text-gray-300 rounded flex items-center justify-center gap-1"><i class="ph-bold ph-upload-simple"></i> Laden</button>
                    <input type="file" id="importFile" accept=".json" class="hidden" onchange="importBackup(this)">
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        let entries = JSON.parse(localStorage.getItem('port_entries')) || [];
        let prices = JSON.parse(localStorage.getItem('port_prices')) || { gold: 0, silver: 0, etf: 0, lastUpdate: 'Nie' };
        let privacy = false;
        let editId = null;

        // --- DOM REFS ---
        const $ = (id) => document.getElementById(id);
        
        // --- INIT ---
        init();
        function init() {
            // Restore manual inputs
            $('mGold').value = prices.gold || ''; $('mSilver').value = prices.silver || ''; $('mEtf').value = prices.etf || '';
            render();
            fetchAllPrices();
        }

        // --- FETCHING (ROBUST) ---
        async function fetchAllPrices() {
            const btn = $('iconRefresh');
            btn.classList.add('spin-slow');
            
            // Helper: Try multiple sources/proxies if one fails
            const fetchTicker = async (symbol) => {
                const urls = [
                    `https://api.allorigins.win/get?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d&ts=${Date.now()}`)}`,
                    `https://corsproxy.io/?${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`)}`
                ];
                
                for(let u of urls) {
                    try {
                        const res = await fetch(u);
                        const data = await res.json();
                        // Handle AllOrigins wrapper vs raw
                        const json = data.contents ? JSON.parse(data.contents) : data;
                        return json.chart.result[0].meta.regularMarketPrice;
                    } catch(e) { console.log(`Fail ${symbol} on ${u}`); continue; }
                }
                return null;
            };

            const [g, s, e] = await Promise.all([fetchTicker('XAUEUR=X'), fetchTicker('XAGEUR=X'), fetchTicker('SXR8.DE')]);
            
            if(g) { prices.gold = g / 31.1034768; $('mGold').value = prices.gold.toFixed(2); }
            if(s) { prices.silver = s / 31.1034768; $('mSilver').value = prices.silver.toFixed(2); }
            if(e) { prices.etf = e; $('mEtf').value = prices.etf.toFixed(2); }

            if(g||s||e) {
                prices.lastUpdate = new Date().toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});
                localStorage.setItem('port_prices', JSON.stringify(prices));
            }
            
            render();
            btn.classList.remove('spin-slow');
        }

        // --- ETF MAGIC FIX (HISTORICAL) ---
        async function autoCalcShares() {
            const amt = parseFloat($('inpAmt').value);
            const date = $('inpDate').value;
            const cat = $('inpCat').value;
            
            if(!amt || !date) { alert("Bitte erst Preis & Datum eingeben."); return; }
            
            let symbol = 'SXR8.DE'; // Default ETF
            if(cat === 'gold') symbol = 'XAUEUR=X';
            if(cat === 'silver') symbol = 'XAGEUR=X';

            const btn = document.querySelector('.ph-magic-wand').parentElement;
            btn.innerHTML = '<i class="ph-bold ph-spinner spin-slow"></i>';
            
            try {
                // Fetch historical close
                const ts = Math.floor(new Date(date).getTime() / 1000);
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${ts}&period2=${ts+86400}&interval=1d`;
                const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                
                const res = await fetch(proxy);
                const data = await res.json();
                const json = JSON.parse(data.contents);
                const close = json.chart.result[0].indicators.quote[0].close[0];
                
                if(close) {
                    let price = close;
                    if(cat !== 'etf') price = price / 31.1034768; // Oz to Gram for metals
                    
                    const shares = amt / price;
                    $('inpWgt').value = shares.toFixed(4);
                    alert(`Kurs am ${date}: ${price.toFixed(2)}€\nBerechnete Anteile: ${shares.toFixed(4)}`);
                } else {
                    throw new Error("Kein Kurs");
                }
            } catch(e) {
                const manual = prompt("Historischer Kurs nicht gefunden (Wochenende?).\nBitte Stückzahl manuell eingeben:", "");
                if(manual) $('inpWgt').value = manual;
            }
            btn.innerHTML = '<i class="ph-fill ph-magic-wand"></i>';
        }

        // --- RENDER ---
        function render() {
            let tInv=0, tVal=0, gVal=0, sVal=0, eVal=0;
            let gInv=0, sInv=0, eInv=0;

            entries.forEach(e => {
                tInv += e.amount;
                let p = 0;
                if(e.category === 'gold') { p = prices.gold; gInv += e.amount; }
                else if(e.category === 'silver') { p = prices.silver; sInv += e.amount; }
                else { p = prices.etf; eInv += e.amount; }
                
                let val = (p > 0) ? e.weight * p : e.amount; // Fallback to cost if no price
                
                if(e.category === 'gold') gVal += val;
                else if(e.category === 'silver') sVal += val;
                else eVal += val;
                
                tVal += val;
            });

            // Main Display
            $('currentValueDisplay').innerText = privacy ? '•••• €' : fmt(tVal);
            const pl = tVal - tInv;
            const plP = tInv > 0 ? (pl/tInv)*100 : 0;
            
            $('plDisplay').innerText = privacy ? '•••• €' : (pl>=0?'+':'') + fmt(pl);
            $('plPercent').innerText = (pl>=0?'+':'') + plP.toFixed(2) + "%";
            $('plPercent').className = "text-xs font-bold " + (pl>=0 ? "text-green-500" : "text-red-500");
            
            $('lastUpdateLabel').innerText = "Stand: " + prices.lastUpdate;

            // Cards
            updateCard('gold', gVal, gInv);
            updateCard('silver', sVal, sInv);
            updateCard('etf', eVal, eInv);
        }

        function updateCard(id, curr, inv) {
            const diff = curr - inv;
            const pct = inv > 0 ? (diff/inv)*100 : 0;
            $(`${id}Val`).innerText = privacy ? '••••' : fmt0(curr);
            $(`${id}PL`).innerText = (diff>=0?'+':'') + pct.toFixed(1) + "%";
            $(`${id}PL`).className = "text-[10px] font-bold " + (diff>=0 ? "text-green-500" : "text-red-500");
        }

        function renderList() {
            const list = $('historyList');
            list.innerHTML = '';
            
            // Group by Date or just list? Minimalist list.
            const sorted = [...entries].sort((a,b) => new Date(b.date) - new Date(a.date));
            
            if(sorted.length === 0) list.innerHTML = '<div class="text-center text-gray-600 mt-10 text-xs">Keine Einträge</div>';

            sorted.forEach(e => {
                let p = (e.category === 'gold') ? prices.gold : (e.category === 'silver' ? prices.silver : prices.etf);
                const val = (p > 0) ? e.weight * p : e.amount;
                const pl = val - e.amount;
                const plP = e.amount > 0 ? (pl/e.amount)*100 : 0;
                const col = pl >= 0 ? 'text-green-500' : 'text-red-500';

                const item = document.createElement('div');
                item.className = 'bg-[#111] p-3 rounded-xl border border-[#222] flex items-center justify-between';
                item.onclick = () => openModal(e.id);
                
                item.innerHTML = `
                    <div>
                        <div class="font-bold text-sm text-white">${e.product}</div>
                        <div class="text-[10px] text-gray-500">${new Date(e.date).toLocaleDateString('de-DE')} • ${e.category.toUpperCase()}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-bold text-gray-300">${privacy ? '•••' : fmt(val)}</div>
                        <div class="text-[10px] ${col}">${pl>=0?'+':''}${plP.toFixed(1)}%</div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // --- ACTIONS ---
        function openModal(id = null) {
            editId = id;
            $('entryModal').classList.remove('hidden'); $('entryModal').classList.add('flex');
            
            if(id) {
                const e = entries.find(x => x.id === id);
                $('modalTitle').innerText = "Bearbeiten";
                $('btnDelete').classList.remove('hidden');
                $('inpCat').value = e.category; $('inpProd').value = e.product;
                $('inpAmt').value = e.amount; $('inpWgt').value = e.weight;
                $('inpLoc').value = e.location || ''; $('inpDate').value = e.date;
            } else {
                $('modalTitle').innerText = "Neu";
                $('btnDelete').classList.add('hidden');
                $('inpCat').value = 'gold'; $('inpProd').value = '';
                $('inpAmt').value = ''; $('inpWgt').value = '';
                $('inpLoc').value = ''; $('inpDate').value = new Date().toISOString().split('T')[0];
            }
            updateUI();
        }
        
        function updateUI() {
            const cat = $('inpCat').value;
            $('lblWeight').innerText = cat === 'etf' ? "Anteile (Stück)" : "Gewicht (g)";
            if(!editId) {
                if(cat === 'etf') $('inpProd').value = "iShares S&P 500";
                else $('inpProd').value = "";
            }
        }

        function saveEntry() {
            const amt = parseFloat($('inpAmt').value);
            const wgt = parseFloat($('inpWgt').value);
            const cat = $('inpCat').value;
            if(!amt) { alert("Betrag fehlt"); return; }
            if(isNaN(wgt)) { alert("Menge/Anteil fehlt (nutze Zauberstab)"); return; }

            const item = {
                id: editId || Date.now(),
                category: cat,
                product: $('inpProd').value || cat.toUpperCase(),
                amount: amt,
                weight: wgt,
                location: $('inpLoc').value,
                date: $('inpDate').value
            };

            if(editId) entries = entries.map(e => e.id === editId ? item : e);
            else entries.push(item);
            
            localStorage.setItem('port_entries', JSON.stringify(entries));
            closeModal();
            render();
            if($('viewHistory').classList.contains('active')) renderList();
        }

        function deleteEntry() {
            if(confirm("Löschen?")) {
                entries = entries.filter(e => e.id !== editId);
                localStorage.setItem('port_entries', JSON.stringify(entries));
                closeModal();
                render();
                if($('viewHistory').classList.contains('active')) renderList();
            }
        }

        // --- SYSTEM ---
        function switchView(v) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            if(v === 'history') { $('viewHistory').classList.add('active'); renderList(); }
            else { $('viewDashboard').classList.add('active'); render(); }
        }
        function togglePrivacy() { privacy = !privacy; $('iconPrivacy').className = privacy ? "ph-bold ph-eye-slash text-xl" : "ph-bold ph-eye text-xl"; render(); }
        function closeModal() { $('entryModal').classList.remove('flex'); $('entryModal').classList.add('hidden'); editId = null; }
        function openSettings() { $('settingsModal').classList.remove('hidden'); $('settingsModal').classList.add('flex'); }
        function closeSettings() { $('settingsModal').classList.add('hidden'); $('settingsModal').classList.remove('flex'); }
        
        function saveManualPrices() {
            prices.gold = parseFloat($('mGold').value) || prices.gold;
            prices.silver = parseFloat($('mSilver').value) || prices.silver;
            prices.etf = parseFloat($('mEtf').value) || prices.etf;
            prices.lastUpdate = "Manuell";
            localStorage.setItem('port_prices', JSON.stringify(prices));
            render(); closeSettings();
        }

        function exportBackup() {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({entries, prices}));
            a.download = "portfolio_backup.json"; a.click();
        }
        function importBackup(el) {
            const r = new FileReader();
            r.onload = e => {
                try {
                    const d = JSON.parse(e.target.result);
                    if(d.entries) entries = d.entries;
                    if(d.prices) prices = d.prices;
                    localStorage.setItem('port_entries', JSON.stringify(entries));
                    location.reload();
                } catch(err) { alert("Backup Fehler"); }
            };
            if(el.files[0]) r.readAsText(el.files[0]);
        }

        function fmt(n) { return new Intl.NumberFormat('de-DE', {style:'currency', currency:'EUR'}).format(n); }
        function fmt0(n) { return new Intl.NumberFormat('de-DE', {style:'currency', currency:'EUR', maximumFractionDigits:0}).format(n); }
    </script>
</body>
</html>
